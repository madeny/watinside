<script>
(function() {
  'use strict';

  // Check for reduced motion preference
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (prefersReducedMotion) {
    // If user prefers reduced motion, make all elements visible immediately
    document.querySelectorAll('.animate-on-scroll').forEach(function(el) {
      el.classList.add('is-visible');
    });
    return;
  }

  // Intersection Observer options
  const observerOptions = {
    root: null,
    rootMargin: '0px 0px -50px 0px',
    threshold: 0.15
  };

  // Create the observer
  const observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        // Unobserve after animation triggers (performance optimization)
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  // Observe all elements with animation class
  function initAnimations() {
    const animatedElements = document.querySelectorAll('.animate-on-scroll');
    animatedElements.forEach(function(el) {
      observer.observe(el);
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAnimations);
  } else {
    initAnimations();
  }

  // Hero Flow Animation
  function initFlowAnimation() {
    const flowContainer = document.querySelector('.hero-flow-animated');
    if (!flowContainer) return;

    const steps = [
      { step: '.flow-step-1', arrow: '.flow-arrow-1' },
      { step: '.flow-step-2', arrow: '.flow-arrow-2' },
      { step: '.flow-step-3', arrow: null }
    ];

    let currentStep = 0;
    const stepDuration = 2500; // Time each step is highlighted
    const arrowDuration = 600; // Arrow animation duration

    function clearAllActive() {
      flowContainer.querySelectorAll('.flow-step, .hero-flow-arrow').forEach(function(el) {
        el.classList.remove('is-active');
      });
    }

    function animateStep() {
      clearAllActive();

      // Activate current step
      const current = steps[currentStep];
      const stepEl = flowContainer.querySelector(current.step);
      if (stepEl) {
        stepEl.classList.add('is-active');
      }

      // Animate arrow after a short delay (if not last step)
      if (current.arrow) {
        setTimeout(function() {
          const arrowEl = flowContainer.querySelector(current.arrow);
          if (arrowEl) {
            arrowEl.classList.add('is-active');
          }
        }, stepDuration - arrowDuration - 200);
      }

      // Move to next step
      currentStep = (currentStep + 1) % steps.length;
    }

    // Start animation after initial page load animation
    setTimeout(function() {
      animateStep();
      setInterval(animateStep, stepDuration);
    }, 1500);
  }

  // Initialize flow animation when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFlowAnimation);
  } else {
    initFlowAnimation();
  }

  // Card Fan Mobile Expand
  function initCardFanExpand() {
    // Only on mobile
    if (window.innerWidth > 768) return;

    // Create overlay element
    const overlay = document.createElement('div');
    overlay.className = 'card-fan-overlay';
    document.body.appendChild(overlay);

    // Handle card fan tap
    const cardFans = document.querySelectorAll('.card-fan');
    cardFans.forEach(function(fan) {
      fan.addEventListener('click', function(e) {
        if (window.innerWidth > 768) return;

        e.preventDefault();

        // Get images from this card fan
        const images = fan.querySelectorAll('.app-screenshot');

        // Build overlay content
        overlay.innerHTML = '<button class="close-btn" aria-label="Close">&times;</button>';

        images.forEach(function(img) {
          const expandedImg = document.createElement('img');
          expandedImg.src = img.src;
          expandedImg.alt = img.alt;
          expandedImg.className = 'expanded-card';
          overlay.appendChild(expandedImg);
        });

        // Show overlay
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Close button handler
        overlay.querySelector('.close-btn').addEventListener('click', closeOverlay);
      });
    });

    // Close on background tap
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        closeOverlay();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        closeOverlay();
      }
    });

    function closeOverlay() {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  // Initialize card fan expand when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCardFanExpand);
  } else {
    initCardFanExpand();
  }
})();
</script>
